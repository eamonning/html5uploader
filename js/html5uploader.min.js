/*
 *   html5uploader ver 1.0 - jQuery plugin
 *   中文：html5拖拽上传jquery插件
 *   作者：Eamonn
 *   博客：http://www.eamonning.com
 
 *	 Dual licensed under the MIT and GPL licenses.
 * 
 *	 Built for jQuery library
 *	 http://jquery.com
 *
 *   使用：
 *   <div id="demo_drop"></div>
 *   $('#demo_drop').html5uploder();
*/
(function(e){e.fn.html5uploder=function(t){var n=!1,r=!n,i={html5supported:function(){return!!navigator.geolocation}()},s={totalFilesize:0,processedFilesize:0,processedErrorFilesize:0},o={debug:"",url:"./submit.php",post:{},inputNmae:"html5uploader",singleFilesizeLimit:1073741824,singleFilesizeLimitFunc:function(e){alert("\u5355\u4e2a\u6587\u4ef6\u5927\u5c0f\u8d85\u8fc7\u9650\u5236")},totalFilesizeLimit:1073741824,totalFilesizeLimitFunc:function(e){alert("\u603b\u6587\u4ef6\u5927\u5c0f\u8d85\u8fc7\u9650\u5236")},html5UnsupportedFunc:function(t){e(t).html("HTML5 Not Supported!")},dropOverFunc:function(e){e.css("background","#CCC")},allUploadedCompleteFunc:function(e,t){},uploadingFunc:function(e,t,n,r){},onloadstartFunc:function(e,t,n){},onloadFunc:function(e,t,n,r){},onerrorFunc:function(e,t,n,r){}},u=this;return t=e.extend(o,t),u.debug=function(n){t.debug&&e("#"+t.debug).append(n+"<br />")},this.each(function(){var r=e(this),o=null,a=t;if(!r[0])return n;o=r[0];if(!a.url)return n;u.debug("args check succeed");if(!i.html5supported)return a.html5UnsupportedFunc(r),n;u.debug("environment check succeed"),u.handleDropOut=function(e){alert(1)},o.addEventListener("dropout",u.handleDrop,!1),u.handleDrop=function(e){u.debug("drop"),e.stopPropagation(),e.preventDefault(),s.totalFilesize=0,s.processedFilesize=0,s.processedErrorFilesize=0,u.processFiles(e.dataTransfer.files)},o.addEventListener("drop",u.handleDrop,!1),u.handleDragOver=function(e){e.stopPropagation(),e.preventDefault(),a.dropOverFunc(r)},o.addEventListener("dragover",u.handleDragOver,!1),u.processFiles=function(e){u.debug("processFiles");if(!e||!e.length)return;var t;s.totalFilesize=0;for(t=0;t<e.length;t++){s.totalFilesize+=e[t].size;if(e[t].size>a.singleFilesizeLimit){a.singleFilesizeLimitFunc(e[t]);return}}if(s.totalFilesize>a.totalFilesizeLimit){a.totalFilesizeLimitFunc(e);return}for(t=0;t<e.length;t++)u.uploadFile(e[t])},u.uploadFile=function(e){u.debug("upload file size["+e.size+"] name["+e.name+"]");var t=new XMLHttpRequest;t.open("POST",a.url),t.onload=function(){s.processedFilesize+=e.size,u.debug("xhr.onload "+e.name),u.debug("response: "+this.responseText),a.onloadFunc(this.responseText,e,s.processedFilesize+s.processedErrorFilesize,s.totalFilesize),s.processedErrorFilesize+s.processedFilesize==s.totalFilesize&&(u.debug("opts.allUploadedCompleteFunc"),a.allUploadedCompleteFunc(s.processedFilesize,s.processedErrorFilesize))},t.onerror=function(){s.processedErrorFilesize+=e.size,u.debug("xhr.onerror "+e.name),u.debug("response: "+this.responseText),a.onerrorFunc(this.responseText,e,s.processedFilesize+s.processedErrorFilesize,s.totalFilesize),s.processedErrorFilesize+s.processedFilesize==s.totalFilesize&&(u.debug("opts.allUploadedCompleteFunc"),a.allUploadedCompleteFunc(s.processedFilesize,s.processedErrorFilesize))},t.upload.onprogress=function(t){var n=s.processedFilesize+s.processedErrorFilesize+t.loaded;a.uploadingFunc(t.loaded,e.size,n,s.totalFilesize),u.debug("xhr.upload.onprogress "+e.name)},t.upload.onloadstart=function(t){u.debug("xhr.upload.onloadstart "+e.name),a.onloadstartFunc(e,s.processedFilesize+s.processedErrorFilesize,s.totalFilesize)};var n=new FormData;n.append(a.inputNmae,e);var r;for(r in a.post)n.append(r,a.post[r]);t.send(n)}})}})(jQuery)